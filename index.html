<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Abandoned House: VR Zombies – Enhanced Quest 3 Experience</title>
  
  <!-- A‑Frame core + extras (CDNs) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.7.0/dist/aframe-extras.min.js"></script>
  
  <!-- Enhanced Styles -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- Game Components -->
  <script src="components/zombie.js"></script>
  <script src="components/gun.js"></script>
  <script src="components/controls.js"></script>
  <script src="components/lighting.js"></script>
  <script src="components/environment.js"></script>
  <script src="components/game-manager.js"></script>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading" class="loading">
    <h2>Loading VR Zombie Experience...</h2>
    <div class="spinner"></div>
    <p>Initializing weapons, zombies, and environment...</p>
  </div>

  <!-- START MENU -->
  <div id="menu" class="ui">
    <div class="panel">
      <div class="title">ABANDONED HOUSE: VR ZOMBIES</div>
      <div class="subtitle">Quest 3 • Enhanced WebXR • Wave Survival</div>
      <div class="btn" id="startBtn">Start Game</div>
      <div class="small">
        VR Controls: Move LS • Turn RS • Shoot RT • Reload A • Teleport X • Sprint L‑Stick • Restart Y<br/>
        Desktop: WASD Move • Mouse Look • Click Shoot • R Reload • Shift Sprint
      </div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameover" class="ui" style="display:none">
    <div class="panel">
      <div class="title">GAME OVER</div>
      <div class="subtitle" id="finalScore">Score 0 • Wave 1</div>
      <div class="btn" id="retryBtn">Restart Game</div>
      <div class="small">
        VR: Press Y to restart instantly<br/>
        Tip: Use teleportation and cover for better survival
      </div>
    </div>
  </div>

  <!-- Enhanced 2D HUD -->
  <div id="hud2d">
    <div class="hudchip">
      <span id="hudWave">Wave 1</span> • 
      <span id="hudScore">Score 0</span>
    </div>
    <div class="hudchip">
      <span id="hudHP">HP 100</span> • 
      <span id="hudAmmo">Ammo 15/90</span>
    </div>
    <div class="hudchip">
      <span id="hudPowers">—</span>
    </div>
  </div>

  <!-- VR Restart Button -->
  <div id="vrRestartBtn" style="display:none">Press Y to Restart</div>

  <!-- Enhanced SCENE -->
  <a-scene 
    id="scene" 
    background="color: #0a0a0a" 
    fog="type: exponential; density: 0.035; color: #1a1a2e" 
    renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; shadowMapType: PCF" 
    vr-mode-ui="enabled: true" 
    cursor="rayOrigin: mouse"
    dynamic-lighting
    environment-manager
    lighting-manager>

    <!-- ENHANCED PLAYER RIG with VR Controls -->
    <a-entity 
      id="rig" 
      movement-controls="fly: false; speed: 0.18; acceleration: 60" 
      position="0 0 3"
      vr-controls>
      <a-entity 
        id="player" 
        camera 
        look-controls 
        wasd-controls-enabled="false" 
        position="0 1.6 0">
      </a-entity>
      <a-entity 
        id="leftHand" 
        hand-controls="hand: left; handModelStyle: lowPoly; color: #15803d">
      </a-entity>
      <a-entity 
        id="rightHand" 
        hand-controls="hand: right; handModelStyle: lowPoly; color: #15803d" 
        gun>
      </a-entity>
    </a-entity>

    <!-- DETAILED ENVIRONMENT (replaced by environment component) -->
    <a-entity id="house" detailed-environment></a-entity>

    <!-- GAME MANAGER -->
    <a-entity id="game" game-manager></a-entity>

  </a-scene>

  <script>
    // Hide loading screen when everything is ready
    document.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      
      scene.addEventListener('loaded', () => {
        // Small delay to ensure all components are initialized
        setTimeout(() => {
          const loading = document.getElementById('loading');
          if (loading) {
            loading.style.opacity = '0';
            setTimeout(() => {
              loading.style.display = 'none';
            }, 500);
          }
        }, 1000);
      });
    });

    // Enhanced VR session management
    document.addEventListener('enter-vr', () => {
      console.log('Entered VR mode');
      // Hide 2D UI elements that might interfere
      const menu = document.getElementById('menu');
      const gameover = document.getElementById('gameover');
      
      if (menu && menu.style.display !== 'none') {
        // Auto-start game when entering VR
        setTimeout(() => {
          if (Game && Game.state === 'menu') {
            Game.startGame();
          }
        }, 1000);
      }
    });

    document.addEventListener('exit-vr', () => {
      console.log('Exited VR mode');
    });

    // Performance monitoring
    let lastFrame = performance.now();
    let frameCount = 0;
    let fps = 60;

    function monitorPerformance() {
      const now = performance.now();
      frameCount++;
      
      if (now - lastFrame >= 1000) {
        fps = Math.round((frameCount * 1000) / (now - lastFrame));
        frameCount = 0;
        lastFrame = now;
        
        // Adjust quality based on performance
        if (fps < 30) {
          console.warn('Low FPS detected:', fps);
          // Could implement quality reduction here
        }
      }
      
      requestAnimationFrame(monitorPerformance);
    }
    
    monitorPerformance();

    // Error handling
    window.addEventListener('error', (event) => {
      console.error('Game error:', event.error);
    });

    // WebXR compatibility check
    if (navigator.xr) {
      navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
        if (!supported) {
          console.warn('VR not supported on this device');
          document.querySelector('.subtitle').textContent += ' (Desktop Mode)';
        }
      });
    } else {
      console.warn('WebXR not available');
      document.querySelector('.subtitle').textContent += ' (Desktop Mode)';
    }
  </script>
</body>
</html>